<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-red: #e63946; }
        body { font-family: 'Inter', sans-serif; background: #f8f9fa; }
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: 700; color: var(--primary-red) !important; }
        .main-container { margin-top: 80px; padding: 2rem; }
        .request-item { background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary-red); border-color: var(--primary-red); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-heartbeat me-2"></i>EMResource</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/settings">Settings</a>
                <a class="nav-link" href="/auth/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>My Emergency Requests</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal">
                <i class="fas fa-plus me-2"></i>New Request
            </button>
        </div>

        <div id="requestsList">
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="mt-3">Loading your requests...</p>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Create Emergency Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <input type="hidden" name="requestId" id="requestId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Request Type *</label>
                                <select class="form-select" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="blood">Blood Donation</option>
                                    <option value="oxygen">Oxygen Supply</option>
                                    <option value="ambulance">Ambulance</option>
                                    <option value="bed">Hospital Bed</option>
                                    <option value="medicine">Medicine</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Urgency Level *</label>
                                <select class="form-select" name="urgency" required>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <textarea class="form-control" name="description" rows="3" required placeholder="Describe the emergency situation in detail..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-control" name="patientName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient Age</label>
                                <input type="number" class="form-control" name="patientAge" min="0" max="120">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Phone *</label>
                                <input type="tel" class="form-control" name="contactPhone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Blood Type (if applicable)</label>
                                <select class="form-select" name="bloodType">
                                    <option value="">Select Blood Type</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">City *</label>
                                <input type="text" class="form-control" name="city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">State *</label>
                                <input type="text" class="form-control" name="state" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Address</label>
                            <textarea class="form-control" name="fullAddress" rows="2" placeholder="Complete address for emergency response"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Deadline (if any)</label>
                            <input type="datetime-local" class="form-control" name="deadline">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitBtn" onclick="submitRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadRequests);

        async function loadRequests() {
            try {
                const response = await fetch('/api/emergency/user/requests');
                const data = await response.json();
                
                const container = document.getElementById('requestsList');
                if (data.success && data.data.length > 0) {
                    const activeRequests = data.data.filter(req => req.status !== 'deleted');
                    const deletedRequests = data.data.filter(req => req.status === 'deleted');
                    
                    let html = '';
                    
                    if (activeRequests.length > 0) {
                        html += activeRequests.map(req => `
                            <div class="request-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5>${req.type.toUpperCase()} - ${req.urgency.toUpperCase()}</h5>
                                    <span class="badge bg-${req.status === 'active' ? 'success' : req.status === 'fulfilled' ? 'info' : 'secondary'}">${req.status}</span>
                                </div>
                                <p class="text-muted">${req.description}</p>
                                ${req.patient?.name ? `<p><strong>Patient:</strong> ${req.patient.name}${req.patient.age ? ` (${req.patient.age} years)` : ''}</p>` : ''}
                                ${req.bloodType ? `<p><strong>Blood Type:</strong> ${req.bloodType}</p>` : ''}
                                ${req.address?.city ? `<p><strong>Location:</strong> ${req.address.city}, ${req.address.state}</p>` : ''}
                                <small class="text-muted">Created: ${new Date(req.createdAt).toLocaleDateString()}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editRequest('${req._id}')">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRequest('${req._id}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    if (deletedRequests.length > 0) {
                        html += `<h5 class="mt-4 mb-3 text-muted">Deleted Requests</h5>`;
                        html += deletedRequests.map(req => `
                            <div class="request-item" style="opacity: 0.6;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5>${req.type.toUpperCase()} - ${req.urgency.toUpperCase()}</h5>
                                    <span class="badge bg-secondary">deleted</span>
                                </div>
                                <p class="text-muted">${req.description}</p>
                                <small class="text-muted">Created: ${new Date(req.createdAt).toLocaleDateString()}</small>
                            </div>
                        `).join('');
                    }
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p>No emergency requests found</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal">Create Your First Request</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p>Error loading requests. Please try again.</p>
                    </div>
                `;
            }
        }

        async function submitRequest() {
            const form = document.getElementById('requestForm');
            const formData = new FormData(form);
            const requestId = formData.get('requestId');
            
            const requestData = {
                type: formData.get('type'),
                urgency: formData.get('urgency'),
                description: formData.get('description'),
                patient: { 
                    name: formData.get('patientName'),
                    age: formData.get('patientAge') || undefined
                },
                contact: { phone: formData.get('contactPhone') },
                bloodType: formData.get('bloodType') || undefined,
                location: { type: 'Point', coordinates: [0, 0] },
                address: { 
                    city: formData.get('city'),
                    state: formData.get('state'),
                    fullAddress: formData.get('fullAddress') || undefined
                },
                deadline: formData.get('deadline') || undefined
            };

            try {
                const url = requestId ? `/api/emergency/${requestId}` : '/api/emergency/request';
                const method = requestId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                    form.reset();
                    document.getElementById('requestId').value = '';
                    document.querySelector('.modal-title').textContent = 'Create Emergency Request';
                    document.getElementById('submitBtn').textContent = 'Submit Request';
                    loadRequests();
                    alert(requestId ? 'Request updated successfully!' : 'Request submitted successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error submitting request');
            }
        }

        async function editRequest(id) {
            try {
                const response = await fetch(`/api/emergency/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const req = data.data;
                    const form = document.getElementById('requestForm');
                    
                    form.querySelector('[name="requestId"]').value = req._id;
                    form.querySelector('[name="type"]').value = req.type;
                    form.querySelector('[name="urgency"]').value = req.urgency;
                    form.querySelector('[name="description"]').value = req.description;
                    form.querySelector('[name="patientName"]').value = req.patient?.name || '';
                    form.querySelector('[name="patientAge"]').value = req.patient?.age || '';
                    form.querySelector('[name="contactPhone"]').value = req.contact?.phone || '';
                    form.querySelector('[name="bloodType"]').value = req.bloodType || '';
                    form.querySelector('[name="city"]').value = req.address?.city || '';
                    form.querySelector('[name="state"]').value = req.address?.state || '';
                    form.querySelector('[name="fullAddress"]').value = req.address?.fullAddress || '';
                    if (req.deadline) {
                        form.querySelector('[name="deadline"]').value = new Date(req.deadline).toISOString().slice(0, 16);
                    }
                    
                    document.querySelector('.modal-title').textContent = 'Edit Emergency Request';
                    document.getElementById('submitBtn').textContent = 'Update Request';
                    
                    new bootstrap.Modal(document.getElementById('requestModal')).show();
                } else {
                    alert('Error loading request details');
                }
            } catch (error) {
                alert('Error loading request details');
            }
        }

        async function deleteRequest(id) {
            if (confirm('Are you sure you want to delete this request?')) {
                try {
                    const response = await fetch(`/api/emergency/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        loadRequests();
                        alert('Request deleted successfully!');
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    alert('Error deleting request');
                }
            }
        }
        
        document.getElementById('requestModal').addEventListener('hidden.bs.modal', function () {
            const form = document.getElementById('requestForm');
            form.reset();
            document.getElementById('requestId').value = '';
            document.querySelector('.modal-title').textContent = 'Create Emergency Request';
            document.getElementById('submitBtn').textContent = 'Submit Request';
        });
    </script>
</body>
</html>