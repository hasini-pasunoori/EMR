<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #e63946;
            --primary-blue: #457b9d;
        }
        body { background: #f8f9fa; font-family: 'Inter', sans-serif; }
        .chat-container { height: 80vh; }
        .chat-list { border-right: 1px solid #dee2e6; }
        .chat-item { padding: 1rem; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .chat-item:hover { background: #f8f9fa; }
        .chat-item.active { background: var(--primary-red); color: white; }
        .messages-container { height: 60vh; overflow-y: auto; padding: 1rem; }
        .message { margin-bottom: 1rem; }
        .message.sent { text-align: right; }
        .message-bubble { display: inline-block; padding: 0.75rem 1rem; border-radius: 20px; max-width: 70%; }
        .message.sent .message-bubble { background: var(--primary-red); color: white; }
        .message.received .message-bubble { background: #e9ecef; color: #333; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand text-danger fw-bold" href="/dashboard">
                <i class="fas fa-heartbeat me-2"></i>EMResource
            </a>
            <a href="/dashboard" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row chat-container">
            <div class="col-md-4 chat-list bg-white rounded shadow-sm">
                <div class="p-3 border-bottom">
                    <h5><i class="fas fa-comments me-2"></i>Messages</h5>
                </div>
                <div id="chatList">
                    <div class="text-center p-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No conversations yet</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8 bg-white rounded shadow-sm">
                <div id="chatArea" class="h-100 d-flex flex-column">
                    <div class="text-center p-5 text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Select a conversation to start messaging</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadChats);
        
        async function loadChats() {
            try {
                const response = await fetch('/api/chat/');
                const data = await response.json();
                if (data.success) displayChats(data.data);
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }
        
        function displayChats(chats) {
            const container = document.getElementById('chatList');
            if (chats.length === 0) return;
            
            let html = '';
            chats.forEach(chat => {
                const otherUser = chat.participants.find(p => p._id !== '<%= user._id %>');
                html += `
                    <div class="chat-item" onclick="openChat('${chat._id}')">
                        <div class="fw-bold">${otherUser.name}</div>
                        <small class="text-muted">${chat.lastMessage?.message || 'No messages yet'}</small>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        async function openChat(chatId) {
            try {
                const response = await fetch(`/api/chat/${chatId}/messages`);
                const data = await response.json();
                if (data.success) displayMessages(data.data);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        function displayMessages(chat) {
            const container = document.getElementById('chatArea');
            const otherUser = chat.participants.find(p => p._id !== '<%= user._id %>');
            
            let html = `
                <div class="p-3 border-bottom">
                    <h6 class="mb-0">${otherUser.name}</h6>
                </div>
                <div class="messages-container flex-grow-1">
            `;
            
            chat.messages.forEach(msg => {
                const isSent = msg.sender._id === '<%= user._id %>';
                html += `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-bubble">${msg.message}</div>
                        <small class="text-muted d-block mt-1">${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                        <button class="btn btn-danger" onclick="sendMessage('${chat._id}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function sendMessage(chatId) {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            try {
                const response = await fetch(`/api/chat/${chatId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    input.value = '';
                    openChat(chatId);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
    </script>
</body>
</html>